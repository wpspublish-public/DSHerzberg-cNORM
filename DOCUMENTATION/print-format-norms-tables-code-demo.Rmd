---
title: "Converting hand-smoothed norms tables into print-format output"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Overview

The workflow of developing norms (i.e., creating raw-to-norm-score lookup tables) has three stages:

1.  Model the raw-to-norm-score relationship using `cNORM` (or custom R code) and create basic lookup tables as output.
2.  Examine the basic lookup tables and apply manual smoothing as needed to prepare the norms for clinical use.
3.  Convert the modified basic lookup tables into print-format lookup tables (or, alternatively, into digital format lookup tables).

Because Stage 2 is a manual modification of `cNORM` output, Stage 3 cannot be reintegrated into the `cNORM` workflow, and must be handled separately. That is the purpose of this script: to accomplish Stage 3. The script takes as its input the basic format lookup table and transforms them into the print format. The script assumes a project with age-stratified norms and multiple tests.

At its core, this conversion consists of a transformation in the hierarchical organization of the data. The input tables embody a data hierarchy which there is one table per test, and each of these tables holds the lookup columns for all age groups. In addition, one looks up raw scores in a left-ward column and reads to the right to find the associated norm scores. Here is the head of one such input table:

    raw    5.0-5.3   5.4-5.7   5.8-5.11   6.0-6.5   6.6-6.11   7.0-7.5   7.6-7.11   8.0-8.5

    0        66        62         58        55         50        47         44        40

    1        70        66         62        58         53        50         47        44

    2        74        70         66        61         57        53         49        46

    3        77        74         70        65         60        56         53        49

    4        80        77         73        68         63        58         55        51

    5        83        80         75        70         65        60         56        53

    6        86        82         77        72         67        62         58        55

    7        89        84         79        74         68        64         60        56

    8        91        86         81        76         70        65         61        57

    9        93        88         83        77         72        67         62        59

Note that the column names are the age range (in `years.months` format) of each age group.

In the print-format lookup tables, these hierarchies are inverted. That is, there is one table per age group, and each of these tables holds the lookup columns for all tests. Furthermore, on the output side, one looks up raw scores in the rightward columns and reads to the left to find the associated standard scores. Here is the head of one such output table:

    perc    ss    LSK-E   LSW-E  RHY-E  RLN-E  SEG-E  SPW-E 

    98      130    27–33  25–38  21–30  73–120 21–25  20–32

    97      129    -       24      -       72      20      19

    97      128    26      -       20      71      -       -

    96      127    -       23      -       70      -       -

    96      126    -       -       19      68–69  19      18

    95      125    25      22      -       67      -       -

    95      124    -       -       18      66      -       -

    94      123    24      21      17      65      18      17

    93      122    -       -       -       64      -       -

    92      121    23      20      16      63      -       -

Note that the column names are the acronym of each test.

#### Executable Code

```{r print-format-norms, eval = FALSE}
suppressMessages(library(here))
suppressMessages(library(tidyverse))
suppressMessages(library(writexl))

input_test_names <- c("lske", "lswe", "rhme", "rlne", "sege", "snwe")
output_test_names <- c("LSK-E", "LSW-E", "RHY-E", "RLN-E", "SEG-E", "SPW-E")
tod_form <- "TOD-E"
norm_type <- "age"
input_file_path <- "INPUT-FILES/PRINT-FORMAT-NORMS-TABLES/"
output_file_path <- "OUTPUT-FILES/PRINT-FORMAT-NORMS-TABLES/"

input_files_ta <- map(
  input_test_names,
  ~
  suppressMessages(read_csv(here(str_c(
  input_file_path, .x, "-", norm_type, ".csv"
))))
) %>% 
  set_names(input_test_names)

perc_ss_cols <- suppressMessages(read_csv(here(str_c(
  input_file_path, "perc-ss-cols.csv"
))))

age_strat <- input_files_ta[[1]] %>% 
  select(-raw) %>% 
  names()

print_lookups_ta <- input_files_ta %>%
  map(~
        .x %>% 
  pivot_longer(contains("-"), names_to = "age_strat", values_to = "ss") %>%
  arrange(age_strat) %>%
  group_by(age_strat) %>%
  complete(ss = 40:130) %>%
  group_by(age_strat, ss) %>%
  filter(n() == 1 | n() > 1 & row_number()  %in% c(1, n())) %>%
  summarize(raw = str_c(raw, collapse = '--')) %>%
  mutate(across(raw, ~ case_when(is.na(.x) ~ '-', TRUE ~ .x))) %>%
  arrange(age_strat, desc(ss)) %>%
  pivot_wider(names_from = age_strat,
              values_from = raw) %>%
  filter(!is.na(ss)) %>%
  right_join(perc_ss_cols, by = "ss") %>%
  relocate(perc, .before = "ss")
) %>% 
  set_names(input_test_names)

age_strat_cols_ta <-  print_lookups_ta %>%
  map( ~
         map(age_strat,
             ~
               .y %>%
               select(perc, ss,!!sym(.x)), .y = .x) %>%
         set_names(age_strat))

age_test_names_flat <- cross2(age_strat, input_test_names) %>% 
  map_chr(str_c, collapse = "_")

age_test_cols_flat <- flatten(age_strat_cols_ta) %>% 
  set_names(age_test_names_flat)

age_test_cols_at <- map(
  age_strat,
  ~
  keep(age_test_cols_flat, str_detect(names(age_test_cols_flat), .x))
)

print_lookups_at <- age_test_cols_at %>% 
  map(
    ~
      .x %>% 
      reduce(left_join, by = c("perc", "ss")) %>% 
      rename_with(~ output_test_names, contains("-"))
  ) %>% 
  set_names(age_strat)

write_xlsx(print_lookups_at,
           here(
             str_c(
               output_file_path, tod_form, "-print-lookup-tables-", norm_type, ".xlsx"
             ))
           )
```

#### Commented Snippets

Text.

```{r print-format-norms, echo = 1:6, eval = F}
```
